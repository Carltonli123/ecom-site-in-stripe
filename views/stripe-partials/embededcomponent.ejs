<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Accept a payment</title>
    <meta name="description" content="A demo of a payment on Stripe" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="checkout.css" />
   
    <script>

    document.addEventListener("DOMContentLoaded", function() {

        var thisOrder = JSON.parse('<%- JSON.stringify(order) %>');

        var line_items = []

        for (const item of thisOrder.checkoutCart.items) {
                console.log("item:", item.product.stripe_price_id);
                line_items.push({
                    price: item.product.stripe_price_id,
                    quantity: item.qty
                });
        }

        // This is your test publishable API key.
        // const stripe = Stripe("pk_test_51Rh4ylR41iH2FLgR3nA7XLCGbTmgAmcctsCZ2Fyfacr7bgNHBiMldo08RY1nj5UUbPwjHzVpvG2Hnin3td4BzOfG00T44Ww48s");

        let checkout;
       
        const emailInput = document.getElementById("email");
        const emailErrors = document.getElementById("email-errors");

        const validateEmail = async (email) => {
        const updateResult = await checkout.updateEmail(email);
        const isValid = updateResult.type !== "error";

        return { isValid, message: !isValid ? updateResult.error.message : null };
        };

        document
        .querySelector("#payment-form")
        .addEventListener("submit", handleSubmit);

        const myHeaders = new Headers();
        myHeaders.append("Content-Type", "application/json");

        const raw = JSON.stringify({
                 ui_mode: 'custom',
                 line_items,
                 mode: 'payment',
                 return_url: 'http://localhost:3000/embededcomponent/complete.html?session_id={CHECKOUT_SESSION_ID}',                 
                 payment_intent_data: {
                     application_fee_amount: 500,
                     transfer_data: {
                         destination: 'acct_1RjKNTR1TrtJD0bV',
                     },
                 },
                 
        });

        const requestOptions = {
            method: "POST",
            headers: myHeaders,
            body: raw,
            redirect: "follow"
        };

        // Fetches a Checkout Session and captures the client secret
        initialize();
        async function initialize() {
        const promise = fetch("/checkoutsession", requestOptions)
            .then((r) => r.json())
            .then((r) => r.session.client_secret);

        const appearance = {
            theme: 'stripe',
        };
        checkout = await stripe.initCheckout({
            fetchClientSecret: () => promise,
            elementsOptions: { appearance },
        });

        checkout.on('change', (session) => {
            // Handle changes to the checkout session
        });

        document.querySelector("#button-text").textContent = `Pay ${
            checkout.session().total.total.amount
        } now`;
        emailInput.addEventListener("input", () => {
            // Clear any validation errors
            emailErrors.textContent = "";
            emailInput.classList.remove("error");
        });

        emailInput.addEventListener("blur", async () => {
            const newEmail = emailInput.value;
            if (!newEmail) {
            return;
            }

            const { isValid, message } = await validateEmail(newEmail);
            if (!isValid) {
            emailInput.classList.add("error");
            emailErrors.textContent = message;
            }
        });

        const paymentElement = checkout.createPaymentElement();
        paymentElement.mount("#payment-element");
        }

        async function handleSubmit(e) {
        e.preventDefault();
        setLoading(true);

        const email = document.getElementById("email").value;
        const { isValid, message } = await validateEmail(email);
        if (!isValid) {
            emailInput.classList.add("error");
            emailErrors.textContent = message;
            showMessage(message);
            setLoading(false);
            return;
        }

        const { error } = await checkout.confirm();

        // This point will only be reached if there is an immediate error when
        // confirming the payment. Otherwise, your customer will be redirected to
        // your `return_url`. For some payment methods like iDEAL, your customer will
        // be redirected to an intermediate site first to authorize the payment, then
        // redirected to the `return_url`.
        showMessage(error.message);

        setLoading(false);
        }

        // ------- UI helpers -------

        function showMessage(messageText) {
        const messageContainer = document.querySelector("#payment-message");

        messageContainer.classList.remove("hidden");
        messageContainer.textContent = messageText;

        setTimeout(function () {
            messageContainer.classList.add("hidden");
            messageContainer.textContent = "";
        }, 4000);
        }

        // Show a spinner on payment submission
        function setLoading(isLoading) {
        if (isLoading) {
            // Disable the button and show a spinner
            document.querySelector("#submit").disabled = true;
            document.querySelector("#spinner").classList.remove("hidden");
            document.querySelector("#button-text").classList.add("hidden");
        } else {
            document.querySelector("#submit").disabled = false;
            document.querySelector("#spinner").classList.add("hidden");
            document.querySelector("#button-text").classList.remove("hidden");
        }
        }

   });
       
    </script>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
        font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        font-size: 16px;
        -webkit-font-smoothing: antialiased;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-content: center;
        height: 100vh;
        width: 100vw;
        }

        form {
        width: 35vw;
        min-width: 500px;
        align-self: center;
        box-shadow: 0px 0px 0px 0.5px rgba(50, 50, 93, 0.1),
            0px 2px 5px 0px rgba(50, 50, 93, 0.1), 0px 1px 1.5px 0px rgba(0, 0, 0, 0.07);
        border-radius: 7px;
        padding: 40px;
        margin-top: auto;
        margin-bottom: auto;
        overflow: scroll;
        }

        /* Payment status page */
        #payment-status {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            row-gap: 30px;
            width: 30vw;
            min-width: 500px;
            min-height: 380px;
            align-self: center;
            box-shadow: 0px 0px 0px 0.5px rgba(50, 50, 93, 0.1),
            0px 2px 5px 0px rgba(50, 50, 93, 0.1), 0px 1px 1.5px 0px rgba(0, 0, 0, 0.07);
            border-radius: 7px;
            padding: 40px;
            opacity: 0;
            animation: fadeInAnimation 1s ease forwards;
        }

        #status-icon {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 40px;
            width: 40px;
            border-radius: 50%;
        }

        h2 {
            margin: 0;
            color: #30313D;
            text-align: center;
        }

        a {
            text-decoration: none;
            font-size: 16px;
            font-weight: 600;
            font-family: Arial, sans-serif;
            display: block;
        }
        a:hover {
            filter: contrast(120%);
        }

        #details-table {
            overflow-x: auto;
            width: 100%;
        }

        table {
            width: 100%;
            font-size: 14px;
            border-collapse: collapse;
        }
        table tbody tr:first-child td {
            border-top: 1px solid #E6E6E6; /* Top border */
            padding-top: 10px;
        }
        table tbody tr:last-child td {
            border-bottom: 1px solid #E6E6E6; /* Bottom border */
        }
        td {
            padding-bottom: 10px;
        }

        .TableContent {
            text-align: right;
            color: #6D6E78;
        }

        .TableLabel {
            font-weight: 600;
            color: #30313D;
        }

        #view-details {
            color: #0055DE;
        }

        #retry-button {
            text-align: center;
            background: #0055DE;
            color: #ffffff;
            border-radius: 4px;
            border: 0;
            padding: 12px 16px;
            transition: all 0.2s ease;
            box-shadow: 0px 4px 5.5px 0px rgba(0, 0, 0, 0.07);
            width: 100%;
        }

        @-webkit-keyframes loading {
            0% {
            -webkit-transform: rotate(0deg);
            transform: rotate(0deg);
            }
            100% {
            -webkit-transform: rotate(360deg);
            transform: rotate(360deg);
            }
        }
        @keyframes loading {
            0% {
            -webkit-transform: rotate(0deg);
            transform: rotate(0deg);
            }
            100% {
            -webkit-transform: rotate(360deg);
            transform: rotate(360deg);
            }
        }
        @keyframes fadeInAnimation {
            to {
                opacity: 1;
            }
        }

        @media only screen and (max-width: 600px) {
            form, #payment-status{
            width: 80vw;
            min-width: initial;
            }
        }
    </style>
  </head>
  <body>
    <!-- Display a payment form -->
    <form id="payment-form">
      <label>
        Email
        <input type="text" id="email"
      /></label>
      <div type="text" id="email-errors"></div>
      <h4>Payment</h4>
      <div id="payment-element">
        <!--Stripe.js injects the Payment Element-->
      </div>
      <button id="submit">
        <div class="spinner hidden" id="spinner"></div>
        <span id="button-text">Pay now</span>
      </button>
      <div id="payment-message" class="hidden"></div>
    </form>
  </body>
</html>